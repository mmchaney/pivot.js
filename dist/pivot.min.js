/*
 * Pivot: A photo gallery using CSS3 3D transforms.
 *
 * By Markus Messner-Chaney, http://markusmessnerchaney.com
 * Public Domain.
 */
/*jshint browser: true, boss: true, curly: true, eqeqeq: true, immed: true,
  newcap: true, noarg: true, noempty: true, overvar: true, undef: true,
  white: true, indent: 2 */
/*global pivot, Element, WebKitCSSMatrix, Modernizr */
(function(a){function f(a,b){var d=c.createElement(a),e;for(e in b)e==="class"?d.className=b[e]:d.setAttribute(e,b[e]);return d}function g(a,d,e,f){a.addEventListener(e,function(e){var g=e.target,h=b.util.slice.call(a.querySelectorAll(d));while(g&&h.indexOf(g)<0)g=g.parentNode;g&&g!==a&&g!==c&&f.call(g,e)},!1)}function h(a,d){while(a!==c&&!b.util.matchesSelector(a,d))a=a.parentNode;return a}function i(a){var c=b.util.slice.call(arguments),d=0,e;return typeof c[1]=="object"?a.replace(/\{(\w+)\}/g,function(){return c[1][arguments[1]]!==undefined?c[1][arguments[1]]:arguments[0]}):a.replace(/\{(\w*)\}/g,function(){return e=c[++d],e!==undefined?e:arguments[0]})}function j(a,b){var c=new XMLHttpRequest;c.addEventListener("readystatechange",function(a){c.readyState===4&&c.status===200&&b(JSON.parse(c.responseText))},!1),c.open("GET",a,!0),c.send()}function k(a,b){var c;return b=b||a.target,c=b.getBoundingClientRect(),{x:Math.max(0,Math.min(1,(a.clientX-c.left)/c.width)),y:Math.max(0,Math.min(1,(a.clientY-c.top)/c.height)),box:c}}function l(a,b){return(a%b+b)%b}function m(a,b,c){this.element=a,this.setType(b),this.element.addEventListener(b,c,!1),this.onTouchEnd=this.onTouchEnd.bind(this),this.onTouchMove=this.onTouchMove.bind(this),this.onTouchStart=this.onTouchStart.bind(this),this.element.addEventListener("touchstart",this.onTouchStart,!1)}function n(a,b,c){return new m(a,b,c)}function o(a){var b=function(a){a.preventDefault()};a.addEventListener("touchmove",b,!1)}var b=a.pivot||(a.pivot={}),c=a.document,d=Element.prototype,e=Function.prototype;b.util={},b.util.slice=[].slice,Modernizr.addTest("devicemotion",function(){return a.ondevicemotion!==undefined}),Modernizr.addTest("matchesselector",function(){var a=["webkit","moz","ms","o"].reduce(function(a,b){return a||d[b+"MatchesSelector"]},d.matchesSelector);return!!(b.util.matchesSelector=a&&e.call.bind(a))}),m.availableEvents=["swipeleft","swiperight"],m.prototype={setType:function(a){this.type=a.toLowerCase(),this.event=c.createEvent("Events"),this.event.initEvent(a,!0,!1)},dispatchEvent:function(a,b){this.type===b.toLowerCase()&&a.dispatchEvent(this.event)},getCoords:function(a){return{x:a.touches[0].pageX,y:a.touches[0].pageY}},onTouchStart:function(a){if(this.startCoords=this.getCoords(a))this.element.addEventListener("touchend",this.onTouchEnd,!1),this.element.addEventListener("touchmove",this.onTouchMove,!1)},onTouchMove:function(a){this.moveCoords=this.getCoords(a)},onTouchEnd:function(a){var b;this.element.removeEventListener("touchend",this.onTouchEnd,!1),this.element.removeEventListener("touchmove",this.onTouchMove,!1),this.moveCoords&&(b={x:this.startCoords.x-this.moveCoords.x,y:this.startCoords.y-this.moveCoords.y},(Math.abs(b.x)>30||Math.abs(b.y)>30)&&this.dispatchEvent(a.target,b.x>0?"swipeleft":"swiperight"),delete this.moveCoords)}},b.util.makeElement=f,b.util.delegate=g,b.util.ancestor=h,b.util.supplant=i,b.util.getJSON=j,b.util.localCoordinates=k,b.util.mod=l,b.util.gesturize=n,b.util.preventTouchScroll=o,Object.prototype.__defineGetter__&&!Object.defineProperty&&(Object.defineProperty=function(a,b,c){"get"in c&&a.__defineGetter__(b,c.get),"set"in c&&a.__defineSetter__(b,c.set)}),typeof Element!=null&&!Element.hasOwnProperty.call(Element.prototype,"classList")&&function(){var a=function(a){return new RegExp("(^|\\s)"+a+"(\\s|$)")},b=function(a){this.element=a},c=function(){return new b(this)};b.prototype={contains:function(b){return a(b).test(this.element.className)},add:function(a){this.contains(a)||(this.element.className+=(this.element.className?" ":"")+a)},remove:function(b){this.element.className=this.element.className.replace(a(b)," ").trim()},toggle:function(b){var c=a(b);c.test(this.element.className)?this.element.className=this.element.className.replace(c," ").trim():this.element.className+=(this.element.className?" ":"")+b}},Object.defineProperty(Element.prototype,"classList",{get:c})}()})(this),function(a){var b=a.pivot||(a.pivot={}),c=a.document,d=b.util.supplant,e=Modernizr.prefixed("Transform");b.Gallery=function(e){var f,g,h;this.wrapper=e.wrapper||c.body,this.quality=e.quality||"medium",this.rows=e.rows,this.columns=e.columns,this.page=1,this.perPage=this.rows*this.columns,h={perPage:this.rows*this.columns},e.userId?(this.feed=b.flickr.feeds.user,h.userId=e.userId):e.groupId?(this.feed=b.flickr.feeds.group,h.groupId=e.groupId):this.feed=b.flickr.feeds.interesting,this.feed=d(this.feed,h),this.photoLoadCount=0,this.photos=[],this.allowedRotation=e.allowedRotation||a.orientation?120:90,this.tiltLag=7,this.rotationDelta={x:0,y:0},this.movementCoordinates={x:0,y:0},this.currentRotation={x:0,y:0},this.onFlickrResult=this.onFlickrResult.bind(this),this.getNextFlickrPage=this.getNextFlickrPage.bind(this),this.constrainLayout=this.constrainLayout.bind(this),this.tilt=this.tilt.bind(this),this.container=b.util.makeElement("div",{"class":"pivot"}),e.wrapper||this.container.classList.add("fullscreen"),this.wrapper.appendChild(this.container),this.viewport=b.util.makeElement("div",{"class":"p-viewport"}),this.zoomPlane=b.util.makeElement("div",{"class":"p-zoom-plane"}),this.viewport.appendChild(this.zoomPlane),this.tiltPlane=b.util.makeElement("div",{"class":"p-tilt-plane"}),this.zoomPlane.appendChild(this.tiltPlane),this.trackingPlane=b.util.makeElement("div",{"class":"p-tracking-plane"}),this.tiltPlane.appendChild(this.trackingPlane);for(f=0;f<this.rows;f++)for(g=0;g<this.columns;g++)this.photos.push(new b.Photo({container:this.trackingPlane,row:f,column:g,rows:this.rows,quality:this.quality}));this.controls=b.util.makeElement("div",{"class":"p-controls"}),this.refresh=b.util.makeElement("button",{"class":"p-refresh"}),this.controls.appendChild(this.refresh),this.constrainLayout(),this.container.appendChild(this.viewport),this.container.appendChild(this.controls),a.addEventListener("resize",this.constrainLayout,!1),this.trackingPlane.addEventListener("load",this.onPhotoLoaded.bind(this),!1),c.addEventListener("keydown",this.onKeyDown.bind(this),!1),b.util.delegate(this.viewport,".p-photo","click",this.onPhotoClickDelegate.bind(this)),this.viewport.addEventListener("mousewheel",this.onViewportMouseWheel.bind(this),!1),this.viewport.addEventListener("DOMMouseScroll",this.onViewportMouseWheel.bind(this),!1),this.refresh.addEventListener("click",this.getNextFlickrPage,!1),this.zoomOut=this.zoomOut.bind(this),this.container.addEventListener("click",this.zoomOut,!1),Modernizr.devicemotion&&Modernizr.touch?(a.addEventListener("devicemotion",this.onDeviceMotion.bind(this),!1),a.addEventListener("orientationchange",this.constrainLayout,!1)):this.container.addEventListener("mousemove",this.onContainerMouseMove.bind(this),!1),Modernizr.touch&&(b.util.preventTouchScroll(c.body),b.util.gesturize(this.viewport,"swipeleft",this.cycle.bind(this,"next"),!0,!1),b.util.gesturize(this.viewport,"swiperight",this.cycle.bind(this,"prev"),!0,!1)),this.zoomOut(),this.getFlickrPage=this.getFlickrPage.bind(this),setTimeout(this.getFlickrPage,400),this.setSelectedPhoto(this.getPhoto(0,0))},b.Gallery.prototype={constrainLayout:function(){var a=this.container.offsetWidth,b=this.container.offsetHeight,c=Math.min(a,b);this.zoomPlane.style.width=this.zoomPlane.style.height=c+"px",a>b?(this.zoomPlane.style.left=(a-b)/2+"px",this.zoomPlane.style.top=0):(this.zoomPlane.style.top=(b-a)/2+"px",this.zoomPlane.style.left=0)},getPhoto:function(a,b){var c=d('.p-photo[data-row="{row}"][data-column="{column}"]',a,b);return this.container.querySelector(c)},getSelectedPhoto:function(){return this.container.querySelector(".p-photo.selected")},setSelectedPhoto:function(a){var b=this.getSelectedPhoto();return b&&(b.classList.remove("selected"),b.classList.remove("flipped")),a.classList.add("selected"),this.track(),a},cycle:function(a){var c=this.getSelectedPhoto(),d=c?parseInt(c.getAttribute("data-row"),10):0,e=c?parseInt(c.getAttribute("data-column"),10):0;switch(a){case"left":e=b.util.mod(e-1,this.columns);break;case"right":e=(e+1)%this.columns;break;case"up":d=b.util.mod(d-1,this.rows);break;case"down":d=(d+1)%this.rows;break;case"next":e<this.columns-1?e++:(e=0,d=d<this.rows-1?d+1:0);break;case"prev":e?e--:(e=this.columns-1,d=d?d-1:this.rows-1)}this.setSelectedPhoto(this.getPhoto(d,e))},sendFlickrRequest:function(a){this.photoLoadCount=0,this.container.classList.add("gallery-loading"),b.util.getJSON(a,this.onFlickrResult)},onFlickrResult:function(a){a.photos.photo.forEach(function(a,b){this.photos[b].insertFlickrData(a)},this),this.photoLoadCount+=this.photos.length-a.photos.photo.length,this.photos.slice(a.photos.photo.length).forEach(function(a){a.setSource("")})},getFlickrPage:function(a){this.page=a>0?a:1,this.sendFlickrRequest(d(this.feed,{page:this.page}))},getNextFlickrPage:function(){this.getFlickrPage(this.page+1)},zoomIn:function(){this.container.classList.add("zoomed"),this.zoomed=!0,this.zoomPlane.style[e]="translate3d(0, 0, 0)",this.track(),this.tilting||this.tilt()},zoomOut:function(){this.container.classList.remove("zoomed"),this.zoomed=!1,this.zoomPlane.style[e]=d("translate3d(0, 0, {z}px)",{z:-this.rows*800}),this.track()},track:function(){var a,b;this.zoomed?(a=this.getSelectedPhoto(),b=d("translate3d({x}%, {y}%, -150px)",{x:a.getAttribute("data-column")*-100,y:a.getAttribute("data-row")*-100})):b=d("translate3d({x}%, {y}%, 1px)",{x:this.columns/2*-100+50,y:this.rows/2*-100+50}),this.trackingPlane.style[e]=b},tilt:function(){var b=this.zoomed&&a.orientation===undefined?this.allowedRotation/4:this.allowedRotation;this.tilting=!0,this.rotationDelta.x=(b*(this.movementCoordinates.y-.5)-this.currentRotation.x)/this.tiltLag,this.rotationDelta.y=(b*(this.movementCoordinates.x-.5)+this.currentRotation.y)/this.tiltLag,this.currentRotation.x+=this.rotationDelta.x,this.currentRotation.y-=this.rotationDelta.y,this.tiltPlane.style[e]=d("rotateX({x}deg) rotateY({y}deg)",this.currentRotation.x,this.currentRotation.y),Math.abs(this.rotationDelta.x)+Math.abs(this.rotationDelta.y)>.05?setTimeout(this.tilt,1e3/30):this.tilting=!1},onPhotoLoaded:function(){this.photoLoadCount++,this.photoLoadCount===this.photos.length&&this.container.classList.remove("gallery-loading")},onPhotoClickDelegate:function(a){var c=b.util.ancestor(a.target,".p-photo");a.target!==c&&a.stopPropagation(),this.setSelectedPhoto(c),this.zoomed||this.zoomIn()},onViewportMouseWheel:function(a){a.wheelDelta||a.detail<0?this.zoomOut():this.onPhotoClickDelegate(a)},onKeyDown:function(a){switch(a.keyCode){case 37:this.cycle("left");break;case 39:this.cycle("right");break;case 38:this.cycle("up");break;case 40:this.cycle("down");break;case 13:this.getSelectedPhoto().classList.toggle("flipped");break;case 82:this.getNextFlickrPage();break;case 32:this.zoomed?this.zoomOut():this.zoomIn()}},onContainerMouseMove:function(a){this.movementCoordinates=b.util.localCoordinates(a,this.container),this.tilting||this.tilt()},onDeviceMotion:function(b){var c=a.orientation%180===0,d=c?"x":"y",e=c?"y":"x",f;f={x:a.orientation===180||a.orientation===90?-1:1,y:a.orientation===0||a.orientation===90?-1:1},this.movementCoordinates.x=(f[d]*b.accelerationIncludingGravity[d]+10)/20,this.movementCoordinates.y=(f[e]*b.accelerationIncludingGravity[e]+10)/20,this.tilting||this.tilt()},onOrientationChange:function(a){this.constrainLayout()}},b.setup=function(a){if(Modernizr&&Modernizr.matchesselector&&Modernizr.csstransforms3d)return new b.Gallery(a)}}(this),function(a){var b=a.pivot||(a.pivot={}),c=a.document,d=b.util.supplant,e=Modernizr.prefixed("Transform");b.Photo=function(a){this.row=a.row,this.column=a.column,this.rows=a.rows,this.quality=a.quality,this.loadEvent=c.createEvent("Events"),this.loadEvent.initEvent("load",!0,!1),this.container=b.util.makeElement("figure",{"class":"p-photo loading no-img","data-row":this.row,"data-column":this.column}),this.container.style[e]=d("translate3d({x}%, {y}%, 1px)",{x:this.column*100,y:this.row*100}),this.backing=b.util.makeElement("div",{"class":"p-backing"}),this.backing.style[e]=d("translate3d({x}px, {y}px, {z}px) rotate({r}deg)",{x:Math.random()*2e3-1e3,y:Math.random()*2e3-1e3,z:Math.random()*-16e3,r:Math.random()*-16e3}),this.backing.style.opacity=0,this.container.appendChild(this.backing),this.imageWrapper=b.util.makeElement("div",{"class":"p-image-wrapper"}),this.container.appendChild(this.imageWrapper),this.caption=b.util.makeElement("figcaption"),this.imageWrapper.appendChild(this.caption),this.image=b.util.makeElement("img",{draggable:!1}),this.imageWrapper.appendChild(this.image),this.imagePreloader=new Image,a.container.appendChild(this.container),this.completeLoading=this.completeLoading.bind(this),this.imagePreloader.addEventListener("load",this.onImagePreloaderLoad.bind(this),!1),this.imagePreloader.addEventListener("error",this.onImagePreloaderError.bind(this),!1),this.imageWrapper.addEventListener("click",this.onImageWrapperClick.bind(this),!1),this.backing.addEventListener("webkitAnimationEnd",this.onBackingAnimationEnd=this.onBackingAnimationEnd.bind(this),!1),this.backing.addEventListener("animationend",this.onBackingAnimationEnd,!1),setTimeout(this.resetBackingTransform.bind(this),0)},b.Photo.prototype={setSource:function(a){this.image.src!==a?(this.container.classList.add("loading"),this.container.classList.remove("flipped"),this.imagePreloader.src=a):this.onImagePreloaderError()},setCaption:function(a){this.caption.innerHTML=a},insertFlickrData:function(a){a.pageURL=d(b.flickr.pageURL,a),a.title=a.title||"Untitled",this.setCaption(d(b.flickr.captionTemplate,a)),this.setSource(d(b.flickr.sourceURLs[this.quality],a))},resetBackingTransform:function(){this.backing.style.cssText=""},completeLoading:function(){this.image.src=this.imagePreloader.src;var a=this.image.naturalWidth/this.image.naturalHeight;a>1?this.wrapperDimensions=d("top: {top}%; left: 5%; width: 90%; height: {height}%;",{top:(100-90/a)/2,height:90/a}):this.wrapperDimensions=d("top: 5%; left: {left}%; width: {width}%; height: 90%;",{left:(100-90*a)/2,width:90*a}),this.imageWrapper.style.cssText=this.wrapperDimensions,this.container.classList.remove("loading"),this.container.classList.remove("no-img"),this.container.classList.add("done-loading"),this.container.dispatchEvent(this.loadEvent)},onBackingAnimationEnd:function(a){this.backing.style.cssText=this.wrapperDimensions,this.container.classList.remove("done-loading")},onImagePreloaderLoad:function(){setTimeout(this.completeLoading,(this.column+this.row*this.rows)*250)},onImagePreloaderError:function(){this.container.classList.add("no-img"),this.container.dispatchEvent(this.loadEvent)},onImageWrapperClick:function(a){b.util.matchesSelector(this.container,".pivot.zoomed .p-photo.selected")&&(a.stopPropagation(),this.container.classList.toggle("flipped"))}}}(this),function(a){var b=a.pivot||(a.pivot={});b.flickr={captionTemplate:'<h1><a href="{pageURL}" target="blank" tabindex="-1">{title}</a></h1><p> By {ownername}</p>',sourceURLs:{high:"http://farm{farm}.static.flickr.com/{server}/{id}_{secret}_b.jpg",medium:"http://farm{farm}.static.flickr.com/{server}/{id}_{secret}_z.jpg",low:"http://farm{farm}.static.flickr.com/{server}/{id}_{secret}_m.jpg"},pageURL:"http://www.flickr.com/photos/{owner}/{id}",feeds:{user:"http://api.flickr.com/services/rest/?method=flickr.people.getPublicPhotos&api_key=6fff138dbd0fbe330c07a67c47c9cc21&user_id={userId}&per_page={perPage}&page={page}&extras=description,owner_name&format=json&nojsoncallback=1",group:"http://api.flickr.com/services/rest/?method=flickr.groups.pools.getPhotos&api_key=6fff138dbd0fbe330c07a67c47c9cc21&group_id={groupId}&per_page={perPage}&page={page}&extras=description,owner_name&format=json&nojsoncallback=1",interesting:"http://api.flickr.com/services/rest/?method=flickr.interestingness.getList&api_key=6fff138dbd0fbe330c07a67c47c9cc21&per_page={perPage}&page={page}&extras=description,owner_name&format=json&nojsoncallback=1"}}}(this)
